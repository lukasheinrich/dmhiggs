<!-- Latest compiled and minified CSS -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mono-Higgs Fiducial Efficiencies - Upload</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static',filename='css/style.css')}}">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>


        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="{{ url_for('static',filename='bootstrap/js/bootstrap.min.js')}}"></script>
        <script src="{{ url_for('static',filename='js/dropzone.js')}}"></script>


        <div id="drophtml">
            <div class="dz-preview dz-file-preview">
                <div id="name">
                    <span class="dz-success-mark"><span>✔</span></span>
                    <span class="dz-error-mark"><span>✘</span></span>
                    <span class="dz-details">
                        <span class="dz-size" data-dz-size></span>
                        <span class="dz-filename"><span data-dz-name></span></span>
                    </span>
                
                </div>
                <div class="dz-progress">
                    <span class="dz-upload" data-dz-uploadprogress></span>
                </div>
            </div>
        </div>

        <script type="text/javascript">
        
        var uploadguid = undefined;
        
        Dropzone.options.dropzone = {

            // Prevents Dropzone from uploading dropped files immediately
            autoProcessQueue: false,
            previewTemplate: $("#drophtml").html(),
            dictDefaultMessage: 'drop MC generated files in LHEF format (or click to select)',  
            uploadMultiple: true,
            parallelUploads: 100,
            init: function() {
                var submitButton = document.querySelector("#submit-all")
                myDropzone = this; // closure
                submitButton.addEventListener("click", function() {
                    myDropzone.processQueue(); // Tell Dropzone to process all queued files.
                });
                
                myDropzone.on('successmultiple',function(files,response){
                    console.log(files)
                    console.log(response)
                    var uploadguid = response['fileguid']
                    $('#process').removeClass('disabled')                    
                    $("#process").click(function(){
                        console.log(uploadguid)
                        console.log('process/'+uploadguid)
                        $.ajax('process/'+uploadguid,{
                            complete: function(data){
                                var taskid = data['responseJSON']['jobguid']
                                console.log('got taskid: '+taskid)
                                location.href = 'monitor/' + taskid
                            }
                        })
                    })

                });
            }
        };

        

        </script>
        
        <script type="text/javascript">
        $(document).ready(function(){

            var socket = io.connect('http://' + document.domain + ':' + location.port + '/monitor');
            socket.emit('subscribe',{data: 'taskid'});
    
            socket.on('pubsubmsg',function(data){
                console.log('got pubsubmsg!')
                console.log(data)
            })

        });
        </script>



        <div class="page-header">
            <h1>Mono-Higgs <small>calculate fiducial efficiencies</small></h1>
        </div>
    
        <div id="container-fluid">
            <div id="row">
                <form action="/upload" method=post enctype=multipart/form-data class="dropzone" id="dropzone">
                    <div class="fallback">
                        <input name="file" type="file" multiple />
                        <input type="submit">submit</input>
                    </div>
                </form>
                <button class="btn btn-default" id="submit-all">upload event files</button>
                <button class="btn btn-default disabled" id="process">process</button>
            </div>            
        </div>

    
    </body>
    </html>